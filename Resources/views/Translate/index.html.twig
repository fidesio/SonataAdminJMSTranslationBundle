{% extends base_template %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" type="text/css" media="screen" href="{{ asset("bundles/jmstranslation/css/layout.css") }}"/>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script language="javascript" type="text/javascript">
        $(document).ready(function () {
            var updateMessagePath = {{ path("jms_translation_update_message", {"config": selectedConfig, "domain": selectedDomain, "locale": selectedLocale})|json_encode|raw }};

            $('#config select').change(function () {
                $(this).closest('form').submit();
            });

            {% if isWriteable is sameas(true) %}
            $('#addTranslation').on('click', function (e) {
                e.preventDefault();
                var form = $(this).closest('form');
                $.ajax({
                    type: 'POST',
                    headers: {'X-HTTP-METHOD-OVERRIDE': 'PUT'},
                    url: form.attr('action'),
                    data: {
                        '_method': 'PUT',
                        'message': form.find('#newTranslationMessage').val(),
                        'id': form.find('#newTranslationId').val()
                    },
                    beforeSend: function () {
                        form.children('.alert-message').remove();
                    },
                    error: function () {
                        form.append('<span class="label label-important alert-message">Could not be saved.</span>');
                    },
                    success: function () {
                        form.append('<span class="label label-success alert-message">Translation was saved.</span>');
                    },
                    complete: function () {
                        $(self).data('timeoutId', setTimeout(function () {
                            $(self).data('timeoutId', undefined);
                            form.children('.alert-message').fadeOut(300, function () {
                                $(this).remove();
                            });
                        }, 10000));
                    }
                })
            });

            $('#clearCache').on('click', function (e) {
                e.preventDefault();
                var btn = $(this);
                $.ajax({
                    type: 'POST',
                    url: $(this).attr('href'),
                    data: {
                        '_method': 'POST'
                    },
                    beforeSend: function () {
                        btn.parent().children('.alert-message').remove();
                    },
                    error: function () {
                        btn.parent().append('<span class="label label-important alert-message">Cache NOT cleared.</span>');
                    },
                    success: function () {
                        btn.parent().append('<span class="label label-success alert-message">Cache cleared.</span>');
                    },
                    complete: function () {
                        $(self).data('timeoutId', setTimeout(function () {
                            $(self).data('timeoutId', undefined);
                            $(this).parent().children('.alert-message').fadeOut(300, function () {
                                $(this).remove();
                            });
                        }, 10000));
                    }
                })
            });

            $('[data-transaltions-container] textarea')
                    .blur(function () {
                        var self = this;
                        $.ajax(updateMessagePath + '?id=' + encodeURIComponent($(this).data('id')), {
                            type: 'POST',
                            headers: {'X-HTTP-METHOD-OVERRIDE': 'PUT'},
                            data: {'_method': 'PUT', 'message': $(this).val()},
                            beforeSend: function () {
                                $(self).parent().closest('td').prev('td').children('.alert-message').remove();
                            },
                            error: function () {
                                $(self).parent().closest('td').prev('td').append('<span class="label label-important alert-message">Could not be saved.</span>');
                            },
                            success: function () {
                                $(self).parent().closest('td').prev('td').append('<span class="label label-success alert-message">Translation was saved.</span>');
                            },
                            complete: function () {
                                var parent = $(self).parent();
                                $(self).data('timeoutId', setTimeout(function () {
                                    $(self).data('timeoutId', undefined);
                                    parent.closest('td').prev('td').children('.alert-message').fadeOut(300, function () {
                                        $(this).remove();
                                    });
                                }, 10000));
                            }
                        });
                    })
                    .focus(function () {
                        this.select();

                        var timeoutId = $(this).data('timeoutId');
                        if (timeoutId) {
                            clearTimeout(timeoutId);
                            $(this).data('timeoutId', undefined);
                        }

                        $(this).parent().children('.alert-message').remove();
                    })
            ;

            $('.remove_translation').on('click', function (e) {
                e.preventDefault();
                var btn = $(this);
                var confirmed = confirm('{{ 'Are you sure you want to delete this translation?'|trans }}');
                if (confirmed == true) {
                    $.ajax({
                        type: 'POST',
                        url: $(this).attr('href'),
                        data: {
                            '_method': 'POST',
                            'id': btn.data('id')
                        },
                        beforeSend: function () {
                            btn.parent().children('.alert-message').remove();
                        },
                        error: function () {
                            btn.parent().append('<span class="label label-important alert-message">Not removed</span>');
                        },
                        success: function () {
                            btn.closest('.translation-row').fadeOut('slow', function () {
                                $(this).remove();
                            });
                        }
                    })
                }
            });

            {% endif %}

            $('.show_spoiler').on('click', function (e) {
                e.preventDefault();
                var block = $(this).closest('.spoiler_block');
                var target = block.find('.spoiler');
                target.slideToggle();
            });
        });
    </script>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-{% if isWriteable is sameas(true) %}10{% else %}12{% endif %}">
            <div data-transaltions-container class="panel panel-default">
                <div class="panel-heading">{{ 'Translation filter'|trans }}</div>

                <form id="config" class="form-inline panel-body sonata-no-margin" role="form" action="{{ path("jms_translation_index") }}" method="get">

                    <div class="form-group">
                        <label for="translation_configuration">{{ 'Bundle'|trans }}</label>
                        <select data-sonata-select2="false" id="translation_configuration" name="config"
                                class="form-control">
                            {% for config in configs %}
                                <option value="{{ config }}"{% if config == selectedConfig %} selected="selected"{% endif %}>{{ config }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="translation_domain">{{ 'Domain'|trans }}</label>
                        <select data-sonata-select2="false" id="translation_domain" name="domain" class="form-control">
                            {% for domain in domains %}
                                <option value="{{ domain }}"{% if domain == selectedDomain %} selected="selected"{% endif %}>{{ domain }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="translation_locale">{{ 'Locale'|trans }}</label>
                        <select data-sonata-select2="false" id="translation_locale" name="locale" class="form-control">
                            {% for locale in locales %}
                                <option value="{{ locale }}"{% if locale == selectedLocale %} selected="selected"{% endif %}>{{ locale }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
        </div>
        {% if isWriteable is sameas(true) %}
        <div class="col-md-2">
            <div class="panel panel-warning">
                <div class="panel-heading">{{ 'Cache'|trans }}</div>
                <div class="panel-body text-center">

                    <a class="btn btn-danger" id="clearCache"
                       href="{{ path('jms_translation_clear_cache', {"locale": selectedLocale}) }}">{{ 'Clear'|trans }}</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% if isWriteable is sameas(false) %}
        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-block alert-danger">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <h4>{{ 'Error!'|trans }}</h4>

                    <p>{{ 'The translation file'|trans }} "<strong>{{ file }}</strong>" {{ 'is not writable'|trans }}.
                    </p>
                </div>
            </div>
        </div>
    {% endif %}

    {% if "xliff" != format %}
        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-block alert-danger">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <h4>{{ 'Error!'|trans }}</h4>

                    <p>
                        Due to limitations of the different loaders/dumpers, some features are unfortunately limited
                        to
                        the XLIFF format.

                        <br/><br/>

                        However, you can easily convert your existing translation files to the XLIFF format by
                        running:<br/>
                        <code>php app/console translation:extract {{ selectedLocale }} --config={{ selectedConfig }}
                            --output-format=xliff</code>
                    </p>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="row">
        <div class="col-md-9">
            <div data-transaltions-container class="">
                {% if newMessages is not empty %}
                    <div class="panel panel-default">
                        <div class="panel-heading">{{ 'New Messages'|trans }}</div>
                        <div class="panel-body">
                            {% include "KASonataAdminJMSTranslationBundle:Translate:messages.html.twig" with {"messages": newMessages} %}
                        </div>
                    </div>
                {% endif %}
                {% if existingMessages is not empty %}
                    <div class="panel panel-default">
                        <div class="panel-heading">{{ 'Existing Messages'|trans }}</div>
                        <div class="panel-body">
                        {% include "KASonataAdminJMSTranslationBundle:Translate:messages.html.twig" with {"messages": existingMessages} %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="col-md-3">
            <div class="panel panel-default">
                <div class="panel-heading">{{ 'New transaltion'|trans }}</div>

                <form class="form panel-body"
                      action="{{ path("jms_translation_create_message", {"config": selectedConfig, "domain": selectedDomain, "locale": selectedLocale}) }}"
                      method="POST">
                    <div class="form-group">
                        <input {% if isWriteable is sameas(false) %}disabled="disabled"{% endif %} id="newTranslationId" type="text" class="form-control" name="id"
                               placeholder="{{ 'Translation ID'|trans }}"/>
                    </div>
                    <div class="form-group">
                        <textarea {% if isWriteable is sameas(false) %}readonly="readonly"{% endif %} id="newTranslationMessage" placeholder="{{ 'Translation message'|trans }}"
                                  name="message"
                                  class="form-control" style="resize: vertical;" rows="10"></textarea>
                    </div>
                    {% if isWriteable is sameas(true) %}
                        <div class="form-group">
                            <input type="submit" class="btn btn-primary" id="addTranslation" value="{{ 'add'|trans }}"/>
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
{% endblock %}
